# Динамическая видимость предложений

## Описание

Новая функциональность **динамической видимости предложений** автоматически скрывает предложения, которых нет в последнем актуальном ране мониторинга, и показывает их снова, когда они появляются в новом запуске.

## Проблема

Ранее в дашбордах отображались все предложения, которые когда-либо были найдены, включая те, которые больше не доступны. Это создавало путаницу и показывало устаревшую информацию.

## Решение

### Ключевые компоненты

1. **`offer_visibility_manager.py`** - Менеджер видимости предложений
   - Отслеживает состояние видимости предложений
   - Определяет раны (runs) в данных мониторинга
   - Фильтрует предложения на основе последнего актуального рана
   - Восстанавливает предложения при их повторном появлении

2. **`generate_inline_charts_dashboard_with_visibility_filter.py`** - Генератор дашбордов
   - Использует оригинальную логику генерации дашбордов
   - Применяет фильтрацию видимости к данным перед генерацией
   - Сохраняет все оригинальные функции и внешний вид
   - Добавляет информацию о фильтрации в заголовок

3. **`run_monitoring_with_visibility_filter.py`** - Скрипт запуска
   - Запускает мониторинг для всех стран
   - Генерирует оригинальные дашборды с фильтрацией видимости
   - Интегрируется с CI/CD

## Как это работает

### 1. Определение ранов

Система автоматически определяет "раны" (runs) в данных мониторинга:
- Раны разделяются интервалами более 5 минут между записями
- Последний ран считается актуальным
- Предыдущие раны используются для сравнения

### 2. Отслеживание предложений

Каждое предложение идентифицируется уникальным ключом:
```
hotel_name|price|dates|from_airport|duration
```

### 3. Управление видимостью

- **Видимые предложения**: есть в последнем актуальном ране
- **Скрытые предложения**: были в предыдущем ране, но исчезли в текущем
- **Новые предложения**: появились в текущем ране
- **Восстановленные предложения**: исчезли ранее, но появились снова

### 4. Состояние видимости

Состояние сохраняется в файле `data/offer_visibility_state.json`:
```json
{
  "last_run_timestamp": "2025-09-16T08:21:00",
  "visible_offers": ["hotel1|1000|2025-09-20|WAW|7"],
  "hidden_offers": ["hotel2|1200|2025-09-21|WAW|7"],
  "offer_history": {
    "hotel1|1000|2025-09-20|WAW|7": {
      "first_seen": "2025-09-15T10:00:00",
      "last_seen": "2025-09-16T08:21:00",
      "disappeared_count": 0,
      "reappeared_count": 1
    }
  }
}
```

## Использование

### Локальное тестирование

```bash
# Тестирование менеджера видимости
python3 offer_visibility_manager.py data/travel_prices.csv

# Генерация дашборда с динамической видимостью
python3 generate_dashboard_with_dynamic_visibility.py data/travel_prices.csv index_dynamic.html

# Полный запуск мониторинга
python3 run_monitoring_with_dynamic_visibility.py
```

### CI/CD интеграция

Новый workflow `.github/workflows/travel_monitor_dynamic_visibility.yml`:
- Запускается каждый час
- Использует динамическую видимость для всех дашбордов
- Автоматически деплоит на GitHub Pages

## Преимущества

1. **Актуальность**: Показываются только доступные предложения
2. **Чистота данных**: Устаревшие предложения автоматически скрываются
3. **Восстановление**: Предложения появляются снова при их доступности
4. **Прозрачность**: Статистика видимости отображается в дашборде
5. **Автоматизация**: Полностью автоматический процесс

## Статистика видимости

В дашборде отображается:
- Количество видимых предложений
- Количество скрытых предложений
- Общее количество отслеживаемых предложений
- Время последнего рана

## Файлы

- `offer_visibility_manager.py` - Основная логика
- `generate_dashboard_with_dynamic_visibility.py` - Генератор дашбордов
- `run_monitoring_with_dynamic_visibility.py` - Скрипт запуска
- `.github/workflows/travel_monitor_dynamic_visibility.yml` - CI workflow
- `data/offer_visibility_state.json` - Состояние видимости (автоматически создается)

## Миграция

Для перехода на новую функциональность:

1. Переключитесь на ветку `feature/dynamic-offers-visibility`
2. Запустите мониторинг с новой функциональностью
3. Проверьте дашборды с динамической видимостью
4. При необходимости настройте CI workflow

## Обратная совместимость

Старые дашборды продолжают работать без изменений. Новая функциональность добавляется как дополнительная опция.
