name: Travel Price Monitor

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∂–¥—ã–π —á–∞—Å
    - cron: "0 * * * *"
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  push:
    branches: [ main, feature/investigate-alerts-issue, feature/airport-comparison ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "travel-monitor"
  cancel-in-progress: false

jobs:
  monitor-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements_dashboard.txt

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        run: |
          playwright install chromium

      - name: Run price monitoring with airport comparison (Greece, Egypt & Turkey)
        run: |
          echo "üöÄ Starting price monitoring with airport comparison at $(date)"
          export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
          export PLAYWRIGHT_BROWSERS_PATH=/home/runner/.cache/ms-playwright
          
          # Run monitoring with airport comparison for all countries
          python run_all_countries_with_airport_comparison.py
          
          echo "‚úÖ Price monitoring with airport comparison completed"

      - name: Run data analysis
        run: |
          echo "üìä Starting data analysis at $(date)"
          python analyze_data.py --charts --export
          echo "‚úÖ Data analysis completed"

      - name: Generate dashboards with airport comparison (Greece, Egypt & Turkey) and landing
        run: |
          echo "üåê Generating dashboards with airport comparison at $(date)"
          
          # Generate all dashboards with airport comparison
          python generate_inline_charts_dashboard_with_airport_comparison_final.py
          
          # Verify dashboards were created
          if [ -f "index_greece.html" ]; then
            echo "‚úÖ Greece dashboard generated"
          else
            echo "‚ö†Ô∏è Greece dashboard not found"
          fi
          
          if [ -f "index_egypt.html" ]; then
            echo "‚úÖ Egypt dashboard generated"
          else
            echo "‚ö†Ô∏è Egypt dashboard not found"
          fi
          
          if [ -f "index_turkey.html" ]; then
            echo "‚úÖ Turkey dashboard generated"
          else
            echo "‚ö†Ô∏è Turkey dashboard not found"
          fi
          
          if [ -f "index.html" ]; then
            echo "‚úÖ Landing page generated"
          else
            echo "‚ö†Ô∏è Landing page not found"
          fi
          
          echo "‚úÖ All dashboards with airport comparison generated"

      - name: Check for price alerts
        id: alerts
        run: |
          echo "üö® Checking for price alerts..."
          ALERT_COUNT="0"
          if [ -f "data/price_alerts_report.txt" ]; then
            ALERT_COUNT=$(grep -c "üìâ\\|üìà" data/price_alerts_report.txt 2>/dev/null || echo "0")
          fi
          # –ù–∞–¥—ë–∂–Ω–∞—è –∑–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π file command (–∏—Å–∫–ª—é—á–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞)
          : > "$GITHUB_OUTPUT"
          {
            echo "alert_count<<EOF"
            echo "$ALERT_COUNT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          printf "Found %s price changes\n" "$ALERT_COUNT"

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Commit and push data updates
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "üìù Committing data changes..."
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –≤–µ—Ç–∫—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å non-fast-forward
          git fetch origin main || true
          git checkout main || true
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —à–∞–≥–æ–≤, –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git stash push -u -m "ci-stash" || true
          git pull --rebase origin main || true
          git stash pop || true
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö –ø—É—Ç–µ–π)
          git add -f data/ || true
          git add index.html index_greece.html index_egypt.html index_turkey.html || true
          git add -f hotel-charts/ hotel-charts/greece/ hotel-charts/egypt/ hotel-charts/turkey/ || true
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∞—ç—Ä–æ–ø–æ—Ä—Ç–æ–≤
          git add -f data/*_airport_comparison.json || true
          git add -f data/*_any_airports.csv || true
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            COMMIT_MSG="üîÑ Hourly update with airport comparison - $(date '+%Y-%m-%d %H:%M:%S UTC')
            
            üìä Data summary:
            - Total offers: $(wc -l < data/travel_prices.csv || echo '0')
            - Unique hotels: $(cut -d',' -f1 data/travel_prices.csv | tail -n +2 | sort -u | wc -l || echo '0')
            - Price range: $(cut -d',' -f2 data/travel_prices.csv | tail -n +2 | sort -n | head -1 || echo 'N/A') - $(cut -d',' -f2 data/travel_prices.csv | tail -n +2 | sort -n | tail -1 || echo 'N/A') PLN
            - Alerts: ${{ steps.alerts.outputs.alert_count }}
            
            üõ´ Airport comparison features:
            - Warsaw vs Any Airport price comparison
            - Missing hotels table (under 8000 PLN)
            - Alternative flight options with savings
            - Direct links to fly.pl offers
            
            ü§ñ Automated by GitHub Actions"
            
            git commit -m "$COMMIT_MSG"
            git push origin HEAD:main
            echo "‚úÖ Changes committed and pushed"
          fi

      - name: Create summary
        if: always()
        run: |
          echo "## üè® Travel Price Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "data/travel_prices.csv" ]; then
            TOTAL_OFFERS=$(wc -l < data/travel_prices.csv)
            UNIQUE_HOTELS=$(cut -d',' -f1 data/travel_prices.csv | tail -n +2 | sort -u | wc -l)
            MIN_PRICE=$(cut -d',' -f2 data/travel_prices.csv | tail -n +2 | sort -n | head -1)
            MAX_PRICE=$(cut -d',' -f2 data/travel_prices.csv | tail -n +2 | sort -n | tail -1)
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Å—ã–ª–æ–∫
            if [ -f "data/travel_prices.csv" ] && grep -q "offer_url" data/travel_prices.csv; then
              OFFERS_WITH_LINKS=$(python3 -c "import pandas as pd; import csv; df = pd.read_csv('data/travel_prices.csv', quoting=csv.QUOTE_ALL, on_bad_lines='skip'); print(len(df[df['offer_url'].notna() & (df['offer_url'] != '')]) if 'offer_url' in df.columns else 0)")
              LINK_PERCENTAGE=$(python3 -c "import pandas as pd; import csv; df = pd.read_csv('data/travel_prices.csv', quoting=csv.QUOTE_ALL, on_bad_lines='skip'); total = len(df); links = len(df[df['offer_url'].notna() & (df['offer_url'] != '')]) if 'offer_url' in df.columns else 0; print(f'{(links / total * 100):.1f}' if total > 0 else '0.0')")
            else
              OFFERS_WITH_LINKS="0"
              LINK_PERCENTAGE="0.0"
            fi
            
            echo "### üìà Data Statistics" >> $GITHUB_STEP_SUMMARY
            echo "- **Total offers:** $TOTAL_OFFERS" >> $GITHUB_STEP_SUMMARY
            echo "- **Unique hotels:** $UNIQUE_HOTELS" >> $GITHUB_STEP_SUMMARY
            echo "- **Price range:** $MIN_PRICE - $MAX_PRICE PLN" >> $GITHUB_STEP_SUMMARY
            echo "- **Price alerts:** ${{ steps.alerts.outputs.alert_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Offers with links:** $OFFERS_WITH_LINKS ($LINK_PERCENTAGE%)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üõ´ Airport Comparison Features" >> $GITHUB_STEP_SUMMARY
          echo "- **Warsaw vs Any Airport** price comparison" >> $GITHUB_STEP_SUMMARY
          echo "- **Missing hotels table** (under 8000 PLN)" >> $GITHUB_STEP_SUMMARY
          echo "- **Alternative flight options** with savings" >> $GITHUB_STEP_SUMMARY
          echo "- **Direct links** to fly.pl offers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### üîó Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Landing](https://andreiYank.github.io/travel-monitoring/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Greece Dashboard](https://andreiYank.github.io/travel-monitoring/index_greece.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Egypt Dashboard](https://andreiYank.github.io/travel-monitoring/index_egypt.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Turkey Dashboard](https://andreiYank.github.io/travel-monitoring/index_turkey.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Data](https://github.com/AndreiYank/travel-monitoring/tree/main/data)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Logs](https://github.com/AndreiYank/travel-monitoring/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
